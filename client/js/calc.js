var tsdLogo = m.trust('<svg class="desktop" width="175" height="55" viewBox="0 0 175 55" xmlns="http://www.w3.org/2000/svg"><g fill="#22354C" fill-rule="evenodd"><path d="M5.815 5.864h113.177V48.27H5.815V5.865zM0 54.134h124.807V0H0v54.135zM135.188 15.94c1.824 0 3.258.918 3.602 2.756l-2.287.92c-.15-.8-.612-1.116-1.33-1.116-.656 0-.97.256-.97.603 0 .572.763.723 1.837 1.07 1.285.406 2.644 1.145 2.644 3.177 0 1.96-1.448 3.133-3.525 3.133-1.823 0-3.258-.918-3.6-2.757l2.285-.918c.15.798.612 1.115 1.33 1.115.657 0 .97-.256.97-.603 0-.572-.762-.723-1.838-1.07-1.284-.406-2.643-1.143-2.643-3.177 0-1.958 1.448-3.133 3.524-3.133M140.344 15.382c.807 0 1.403.603 1.403 1.417 0 .81-.596 1.414-1.403 1.414-.806 0-1.404-.603-1.404-1.415 0-.815.598-1.418 1.404-1.418zm-1.195 3.57h2.39v7.532h-2.39v-7.53zM151.49 18.772c1.538 0 2.762 1.068 2.762 2.982v4.73h-2.39V22.52c0-.95-.39-1.415-1.12-1.415-.896 0-1.285.676-1.285 1.717v3.66h-2.39V22.52c0-.95-.388-1.415-1.12-1.415-.897 0-1.285.676-1.285 1.717v3.66h-2.39v-7.53h2.33v1.128c.434-.71 1.09-1.31 2.3-1.31 1 0 1.808.42 2.226 1.355.374-.768 1.226-1.355 2.36-1.355M154.927 29.496V18.953h2.39v1.023c.538-.768 1.375-1.22 2.405-1.22 1.718 0 3.272 1.326 3.272 3.962s-1.54 3.96-3.227 3.96c-1.15 0-2.002-.57-2.45-1.265v4.083h-2.39zm5.617-6.778c0-.994-.763-1.582-1.63-1.582-.865 0-1.627.588-1.627 1.582 0 .994.762 1.58 1.628 1.58.866 0 1.63-.586 1.63-1.58zM163.518 15.94h2.39v10.544h-2.39V15.94zM170.346 18.772c2.24 0 3.75 1.49 3.75 4.036v.648h-5.214l.014.03c.344.693 1.12.918 1.734.918.775 0 1.448-.195 1.97-.542l.927 2.02c-.628.42-1.508.782-2.972.782-2.69 0-4.123-1.823-4.123-3.992 0-2.23 1.508-3.9 3.914-3.9zm-.12 1.988c-.657 0-1.195.286-1.404 1.01h2.674c-.075-.558-.538-1.01-1.27-1.01zM135.562 30.157c2.957 0 5.064 2.228 5.064 5.27 0 3.044-2.107 5.273-5.064 5.273h-3.93V30.157h3.93zm0 2.56h-1.39v5.423h1.39c1.524 0 2.525-1.176 2.525-2.712 0-1.537-1-2.712-2.525-2.712zM144.93 32.988c2.33 0 4.078 1.536 4.078 3.946s-1.748 3.947-4.078 3.947-4.078-1.536-4.078-3.946 1.748-3.946 4.078-3.946zm0 2.365c-.866 0-1.63.588-1.63 1.58 0 .996.764 1.583 1.63 1.583.866 0 1.63-.587 1.63-1.582 0-.993-.764-1.58-1.63-1.58zM149.533 30.157h2.39V40.7h-2.39V30.157zM152.52 30.157h2.39V40.7h-2.39V30.157zM159.035 33.003c2.24 0 3.436.95 3.436 3.224v4.488h-2.39v-.994c-.328.513-.986 1.145-2.21 1.145-1.405 0-2.51-.918-2.51-2.35 0-1.355.986-2.26 2.375-2.38l2.017-.18c.24-.03.33-.105.33-.24v-.06c0-.272-.344-.467-1.092-.467-.612 0-1.464.134-1.822.737l-1.673-1.326c.613-1.13 2-1.597 3.54-1.597zm1.046 4.52l-1.51.18c-.476.06-.745.285-.745.632 0 .392.3.633.85.633.822 0 1.406-.542 1.406-1.31v-.136zM167.49 32.988c.285 0 .495.045.718.12v2.606c-.268-.105-.642-.15-.97-.15-1.076 0-1.704.497-1.704 1.807v3.33h-2.39v-7.532h2.3v1.31c.374-.902 1.002-1.49 2.047-1.49"></path></g></svg>');
var reviewsLogo = m.trust('<svg xmlns="http://www.w3.org/2000/svg" width="236" height="33" viewBox="0 0 236 33"><g fill="#000" fill-rule="evenodd"><path d="M.71.522h10.21c7.28 0 11.37 4.91 11.37 10.9 0 4.08-1.73 7.86-5.41 9.64l6.28 11.16h-8.14L7.9 18.592v13.63H.71V.522zm7.19 6.95v8.34h2.48c3.06 0 4.59-2.09 4.59-4.3 0-2.61-1.57-4.04-4.59-4.04H7.9z"></path><path d="M21.96 21.372c0-6.21 4.59-11.29 10.83-11.29 6.33 0 10.84 4.9 10.84 11.29v2.34H28.66c.66 2 2.19 3.08 4.18 3.08 1.77 0 2.77-.69 3.47-1.86h7.15c-1.73 4.86-4.96 7.72-10.62 7.72-6.87 0-10.88-4.99-10.88-11.28zm6.99-2.91h7.86c-.71-1.61-2.11-2.44-3.89-2.44-1.82 0-3.23.92-3.97 2.44zM42.55 10.512h7.32l3.85 11.77 3.8-11.77h7.2l-7.53 21.71h-6.95l-7.69-21.71M69.51.662c2.44 0 4.1 1.77 4.1 4.29s-1.66 4.26-4.1 4.26c-2.39 0-4.05-1.74-4.05-4.26 0-2.52 1.66-4.29 4.05-4.29zm-3.55 9.85h7.15v21.71h-7.15v-21.71zM74.64 21.372c0-6.21 4.59-11.29 10.83-11.29 6.33 0 10.84 4.9 10.84 11.29v2.34H81.34c.66 2 2.19 3.08 4.17 3.08 1.78 0 2.77-.69 3.48-1.86h7.15c-1.74 4.86-4.96 7.72-10.63 7.72-6.86 0-10.87-4.99-10.87-11.28zm6.99-2.91h7.85c-.7-1.61-2.11-2.44-3.88-2.44-1.82 0-3.23.92-3.97 2.44zM95.4 10.512h7.03l3.47 11.72 3.93-11.72h6.08l3.68 11.72 3.68-11.72h6.98l-7.23 21.71h-6.54l-3.76-11.33-3.93 11.33h-6.53l-6.86-21.71M129.84 24.842h7.07v.13c0 1.13.7 1.56 1.9 1.56 1.33 0 1.78-.52 1.78-1.26 0-.86-1.78-1-3.89-1.52-2.85-.56-6.61-1.86-6.61-6.68 0-4 3.22-6.99 8.47-6.99 5.21 0 8.61 2.73 8.69 7.33h-6.91v-.04c0-1.13-.66-1.56-1.78-1.56-1.11 0-1.61.52-1.61 1.13 0 .82 1.86.95 3.93 1.47 3.31.61 6.62 2.04 6.62 6.78 0 4.03-2.98 7.46-8.69 7.46-6.28 0-8.76-3.08-8.97-7.81M152.58 24.142c2.4 0 4.05 1.78 4.05 4.3 0 2.52-1.65 4.26-4.05 4.26-2.44 0-4.05-1.74-4.05-4.26 0-2.52 1.65-4.3 4.05-4.3M157.75 21.372c0-6.26 4.55-11.29 10.88-11.29 5.91 0 10.46 4.25 10.91 10.03h-7.07c-.41-1.96-1.9-3.22-3.84-3.22-2.28 0-4.02 1.91-4.02 4.48 0 2.64 1.62 4.42 4.06 4.42 1.98 0 3.43-1.34 3.8-3.34h7.07c-.41 5.86-4.92 10.2-10.91 10.2-6.41 0-10.88-4.86-10.88-11.28M180.66 21.372c0-6.26 4.55-11.29 10.87-11.29 6.2 0 10.88 5.03 10.88 11.29 0 6.25-4.55 11.28-10.88 11.28-6.32 0-10.87-5.03-10.87-11.28zm14.88 0c0-2.52-1.73-4.48-4.01-4.48-2.27 0-3.97 1.96-3.97 4.48 0 2.51 1.7 4.42 3.97 4.42 2.28 0 4.01-1.91 4.01-4.42zM203.94 10.512h6.98v2.61c1.25-1.96 3.19-3.04 5.5-3.04 2.77 0 4.76 1.17 5.88 3.38 1.28-2.12 3.43-3.38 5.95-3.38 4.63 0 7.24 3.04 7.24 8.29v13.85h-7.12v-12.24c0-2.26-.7-3.52-2.52-3.52-1.61 0-2.6 1.21-2.6 3.82v11.94h-7.12v-12.24c0-2.26-.74-3.52-2.52-3.52-1.61 0-2.64 1.21-2.64 3.82v11.94h-7.03v-21.71"></path></g></svg>');

window.calc = {};

window.calc.checkbox = function(valProp, label, hint) {
    // type is "radio" or "checkbox"
    // <label class="checkbox "
    return m('.calc-item', [
        m('label.checkbox', {
            class: valProp() ? 'active' : ''
        }, [
            m('input', {
                type: 'checkbox',
                checked: valProp(),
                onchange: m.withAttr('checked', valProp)
            }),
            m('span.checkbox-box'),
            m('div.checkbox-label', [
                m('strong', label || ''),
                hint ? m('span.hint', hint || '') : null,
            ])
        ])
    ]);
};

window.calc.radios = function(valProp, items, customOnClick) {
    // items is obj of {val, label, hint}

    function runCallbacks(cb) {
        return function(e) {
            m.withAttr('value', valProp)(e);
            if (cb) cb();
        };
    }

    return m('.calc-item', items.map(function(item) {
        return m('label.checkbox', {
            class: valProp() == item.val ? 'active' : ''
        }, [
            m('input', {
                type: 'radio',
                checked: valProp() == item.val,
                value: item.val,
                onclick: runCallbacks(customOnClick)
            }),
            m('span.checkbox-dot'),
            m('div.checkbox-label', [
                m('strong', item.label || ''),
                m('span.hint', item.hint || ''),
            ])
        ]);
    }));
};

window.calc.checklist = function(valProp, items) {
    // Assumes prop is an object with properties either true or false
    // eg {value1: false, value2: true}

    var items = Object.keys(valProp());

    return m('.calc-item', items.map(function(item) {
        return m('label.checkbox', {
            class: valProp()[item] || false ? 'active' : ''
        }, [
            m('input', {
                type: 'checkbox',
                checked: valProp()[item] || false,
                value: item,
                onclick: function (e) {
                    var items = valProp();
                    m.withAttr('value', function (value) {
                        items[value] = !items[value]; // toggle this item
                        valProp(items);
                        console.log(valProp());
                    })(e);
                }
            }),
            m('span.checkbox-dot'),
            m('div.checkbox-label', [
                m('strong', item || '')
            ])
        ]);
    }));
};

window.calc.pieChart = function(values) {
    // values should be an array of {val: 129, color: "#ff0000", label: "meow food"}
    return m(".calc-item.row.gap-2.middle", [
        m('svg.pie-chart', {
            config: function(e, alreadyInitialized) {
                var width = 150,
                    height = 150,
                    radius = Math.min(width, height) / 2;

                var svg = d3.select(e).html("").append("g").attr("transform", "translate(" + height / 2 + "," + height / 2 + ")");

                var arc = d3.svg.arc()
                    .outerRadius(radius - 10)
                    .innerRadius(0);

                var labelArc = d3.svg.arc()
                    .outerRadius(radius - 40)
                    .innerRadius(radius - 40);

                var pie = d3.layout.pie()
                    .sort(null)
                    .value(function(d) {
                        return d.val;
                    });

                var g = svg.selectAll(".arc")
                    .data(pie(values))
                    .enter().append("g")
                    .attr("class", "arc");

                g.append("path")
                    .attr("d", arc)
                    .style("fill", function(d) {
                        return d.data.color;
                    })
                    .style("stroke", "#fff");
            }
        }),
        m("div.legend", values.map(function(item) {
            return m("div.legend-item", [
                m("div.legend-square", {
                    style: 'background-color:' + item.color
                }),
                item.label
            ]);
        }))
    ]);
};

window.calc.lineChart = function(lines) {
    // lines should be an array of {vals: [[x, y], [x2, y2], color: "#ff0000", label: "meow food"}
    return m(".calc-item.col.right", [
        m('svg.line-chart', {
            config: function(e, alreadyInitialized) {
                var margin = {
                        top: 5,
                        right: 0,
                        bottom: 30,
                        left: 40
                    },
                    width = 330 - margin.left - margin.right,
                    height = 200 - margin.top - margin.bottom;

                var x = d3.scale.linear()
                    .range([0, width]);
                var y = d3.scale.linear()
                    .range([height, 0]);

                var xAxis = d3.svg.axis()
                    .scale(x)
                    .orient("bottom");
                var yAxis = d3.svg.axis()
                    .scale(y)
                    .orient("left");
                var line = d3.svg.line()
                    .interpolate("basis")
                    .x(function(d) {
                        return x(d[0]);
                    })
                    .y(function(d) {
                        return y(d[1]);
                    });

                var svg = d3.select(e).html("")
                    .attr("width", width + margin.left + margin.right)
                    .attr("height", height + margin.top + margin.bottom)
                    .append("g")
                    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
                x.domain([
                    d3.min(lines, function(line) {
                        return d3.min(line.vals, function(v) {
                            return v[0];
                        });
                    }),
                    d3.max(lines, function(line) {
                        return d3.max(line.vals, function(v) {
                            return v[0];
                        });
                    })
                ]);
                y.domain([
                    d3.min(lines, function(line) {
                        return d3.min(line.vals, function(v) {
                            return v[1];
                        });
                    }),
                    d3.max(lines, function(line) {
                        return d3.max(line.vals, function(v) {
                            return v[1];
                        });
                    })
                ]);

                svg.append("g")
                    .attr("class", "x chart-axis")
                    .attr("transform", "translate(0," + height + ")")
                    .call(xAxis);

                svg.append("g")
                    .attr("class", "y chart-axis")
                    .call(yAxis);
                /*.append("text")
                .attr("transform", "rotate(-90)")
                .attr("y", 6)
                .attr("dy", ".71em")
                .style("text-anchor", "end")
                .text("Temperature (ÂºF)");*/

                var func = svg.selectAll(".chart-line")
                    .data(lines)
                    .enter().append("g")
                    .attr("class", "func");

                func.append("path")
                    .attr("class", "chart-line")
                    .attr("d", function(d) {
                        return line(d.vals);
                    })
                    .style("stroke", function(d) {
                        return d.color;
                    });

                // remove first tick from y axis
                svg.selectAll(".y.chart-axis .tick").each(function(d) {
                    if (d === 0) {
                        this.remove();
                    }
                });
            }
        }),
        m("div.legend", lines.map(function(item) {
            return m("div.legend-item", [
                m("div.legend-square", {
                    style: 'background-color:' + item.color
                }),
                item.label
            ]);
        }))
    ]);

};

function identity(value) {
    return value;
}

// second variable, if set, makes it a collapsing table
window.calc.table = function(data, expanded_prop) {
    // data should be a two dimensional array
    var firstRow = true;
    var expanded = expanded_prop == null || expanded_prop() === true;
    var collapse_class = expanded ? "" : ".collapse"
    return m(".calc-item", [
        m(".table-wrap" + collapse_class, [
            m("table.table", data.map(function(row) {
                var rowName = "tr.table-row";
                if (firstRow) {
                    rowName = "tr.table-header";
                }
                firstRow = false;
                return m(rowName, row.map(function(cell) {
                    return m("td.table-cell", cell);
                }))
            })),
            expanded ? null : m("a.table-expand-link", {
                    href: "#",
                    onclick: function() {
                        expanded_prop(true);
                        return false;
                    }
                },
                "View More"),
            typeof expanded_prop == 'function' && expanded_prop() === true ? m("a.table-collapse-link", {
                    href: "#",
                    onclick: function() {
                        expanded_prop(false);
                        return false;
                    }
                },
                "Collapse") : null,
        ])
    ]);
}

window.calc.resultDisplay = function(num, header, hint, options) {
    if (!options) options = {};
    return m(".calc-item", [
        m(options.style == 'nobkgd' ? ".col.justify.gap-2" : ".result.col.justify.gap-2", [
            m(".row.gap-3.middle", [
                options.addsymbol === true ?
                m("div.result-text.fill-2.good.row.justify.middle", [m('span.plus-sign', "+"), m('span', num)]) :
                m("div.result-text.fill-2.good", num),
                m(".col.justify.fill-3.gap-1", [
                    m(".range-header", header || ''),
                    hint ? m(".hint", hint || '') : null
                ])
            ]),
            options.addsymbol === true ? m('.addline') : []
        ])
    ]);
}

// rangeVal will always be of type Number and inputVal (internal) will _usually_ be of type string
window.calc.range = function(opts) {
    var header = opts.header;
    var rangeVal = opts.val;
    if (opts.range) {
        var min = opts.range[0];
        var max = opts.range[1];
        var step = opts.range[2];
    }
    var hint = opts.hint;
    var customOnInput = opts.customOnInput;
    var type = opts.type;

    var inputVal;
    if (type == "money") {
        inputVal = m.prop(calc.formatMoney(rangeVal()));
    } else if (type == "percent") {
        inputVal = m.prop(calc.formatPercent(rangeVal()));
    } else if (type == "number") {
        inputVal = m.prop(calc.formatNumber(rangeVal()));
    } else {
        inputVal = m.prop(rangeVal());
    }

    function inputToRange(inputVal, rangeVal, cb) {
        return function(e) {
            m.withAttr("value", inputVal)(e);
            if (type == "money") {
                rangeVal(calc.unformatMoney(inputVal()));
            } else if (type == "percent") {
                rangeVal(calc.unformatPercent(inputVal()));
            } else if (type == "number") {
                rangeVal(calc.unformatNumber(inputVal()));
            } else {
                rangeVal(inputVal());
            }

            if (cb) cb();
        };
    }

    function rangeToInput(rangeVal, inputVal, cb) {
        return function(e) {
            m.withAttr("value", rangeVal)(e);
            if (type == "money") {
                inputVal(calc.formatMoney(rangeVal()));
            } else if (type == "percent") {
                inputVal(calc.formatPercent(rangeVal()));
            } else {
                inputVal(rangeVal());
            }

            if (cb) cb();
        };
    }

    // customOnInput = customOnInput ? customOnInput(rangeVal) : m.withAttr("value", rangeVal);
    return m(".calc-item", [
        m(".range.col.justify.gap-2", [
            m(".row.gap-3.middle", [
                m("input.range-text.good" + (opts.range ? "" : " border"), {
                    onchange: inputToRange(inputVal, rangeVal, customOnInput),
                    value: inputVal()
                }),
                m(".col.justify.fill-4.gap-1", [
                    m(".range-header", header || ''),
                    hint ? m(".hint", hint || '') : null,
                    opts.range ? m("input[type=range].range-input", {
                        min: min,
                        max: max,
                        step: step || 1,
                        oninput: rangeToInput(rangeVal, inputVal, customOnInput),
                        value: rangeVal()
                    }) : null,
                ])
            ]),
        ])
    ]);
};

// window.calc.calc = function(inside, opts) {
//     var noBorders = opts && opts.noBorders;
//     var reviews = opts && opts.reviews;
//     var calcClass = ".calc.row.center.gap-5";
//     if (noBorders === true) calcClass = calcClass + ".no-borders";
//     if (reviews === true) calcClass = calcClass + ".reviews";

//     return m("html", [
//         m("head", [
//             m("link", {
//                 rel: 'stylesheet',
//                 href: 'https://fonts.googleapis.com/css?family=Source+Sans+Pro|Source+Code+Pro:700'
//             }),
//             m("link", {
//                 rel: 'stylesheet',
//                 href: 'normalize.css'
//             }),
//             m("link", {
//                 rel: 'stylesheet',
//                 href: 'flexblocks.css'
//             }),
//             m("link", {
//                 rel: 'stylesheet',
//                 href: 'site.css'
//             }),
//             m("meta", {
//                 name: 'viewport',
//                 content: 'width=device-width, initial-scale=1'
//             })
//         ]),
//         m("body", {
//             config: function(el) {
//                 window.setInterval(function() {
//                     parent.postMessage((el.offsetHeight || el.clientHeight), '*');
//                 }, 500);
//             }
//         }, [
//             m(calcClass, {}, [
//                 inside(),
//     // m('div.logo', {
//     //     // href: 'http://www.thesimpledollar.com'
//     // }, reviews ? reviewsLogo : tsdLogo)
//             ])
//         ])
//     ]);
// };

Number.prototype.format = function(n, x) {
    var re = '\\d(?=(\\d{' + (x || 3) + '})+' + (n > 0 ? '\\.' : '$') + ')';
    return this.toFixed(Math.max(0, ~~n)).replace(new RegExp(re, 'g'), '$&,');
};

String.prototype.replaceAll = function(find, replace) {
    function escapeRegExp(str) {
        return str.replace(/([.*+?^=!:${}()|\[\]\/\\])/g, "\\$1");
    }
    return this.replace(new RegExp(escapeRegExp(find), 'g'), replace);
};

window.calc.formatMoney = function(number) {
    number = Number(number);
    var money = number.format(0);
    return "$" + money;
};

window.calc.unformatMoney = function(money) {
    money = String(money);
    return Number(money.replaceAll("$", "").replaceAll(",", ""));
};

window.calc.formatPercent = function(number) {
    number = Number(number);
    var percent = number.format(3);
    return percent + "%";
};

window.calc.unformatPercent = function(percent) {
    percent = String(percent);
    return Number(percent.replaceAll("%", ""));
};

window.calc.formatNumber = function(number) {
    number = Number(number);
    return number.format(0);
};

window.calc.unformatNumber = function(number) {
    return Number(number.replaceAll(",", ""));
};
